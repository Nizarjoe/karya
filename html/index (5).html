<!--
Prototype Timeline Kolaboratif Seni - Oktoberâ€“November
Fitur: Mock auth, Markdown editor, ekspor/impor (MD, PDF, DOCX, XLSX, ICS)
Desain: UI modern seperti Notion + Framer + Linear
Teknologi: TailwindCSS (CDN) + Vanilla JS + LocalStorage
Dependensi CDN digunakan: Tailwind, marked.js, jsPDF, SheetJS (xlsx), FileSaver, docx (umd), GSAP, lucide icons
Catatan migrasi: Untuk migrasi ke Next.js/TypeScript, pisahkan menjadi komponen: Header, Hero, Timeline, Editor, Admin. Ganti mock auth dengan NextAuth + Supabase/Firebase.
-->

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timeline Pementasan Oktoberâ€“November â€” Prototype</title>
  <meta name="description" content="Kelola timeline pementasan: edit dengan Markdown, ekspor ke PDF/Word/Excel/ICS, dan kolaborasi mock. Prototype single-file." />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --purple-900:#3B0A5A;
      --gold:#C69C3E;
    }
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    /* tiny glassmorphism */
    .glass{background: rgba(255,255,255,0.6); backdrop-filter: blur(6px);}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9)); border-radius:14px; box-shadow: 0 8px 24px rgba(11,11,19,0.08);}
    .gold{color:var(--gold)}
    .purple{color:var(--purple-900)}
    /* simple toast */
    .toast{position:fixed; right:20px; bottom:20px; z-index:60}
  </style>
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- docx UMD (if blocked, feature degrades) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.2.0/build/index.umd.js"></script>
  <!-- GSAP for subtle animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
  <!-- Lucide icons -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/lucide-static@0.0.0/dist/index.browser.esm.js"></script>
</head>
<body class="bg-gradient-to-b from-white via-white to-gray-50 text-gray-800">
  <!-- Header -->
  <header class="w-full sticky top-0 z-40 bg-white/60 glass border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background:linear-gradient(135deg,var(--purple-900),#6b2b7a); color:white">ðŸŽ­</div>
        <div>
          <div class="text-lg font-semibold purple">Pementasan Oktâ€“Nov</div>
          <div class="text-xs text-gray-500">Timeline kolaboratif â€” prototype</div>
        </div>
      </div>
      <nav class="flex items-center gap-3">
        <button id="btnHome" class="px-3 py-2 rounded-md text-sm hover:bg-gray-100">Home</button>
        <button id="btnTimeline" class="px-3 py-2 rounded-md text-sm hover:bg-gray-100">Timeline</button>
        <button id="btnAdmin" class="px-3 py-2 rounded-md text-sm hover:bg-gray-100">Admin</button>
        <div id="authArea"></div>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-5 py-8">
    <!-- Routes will be rendered here -->
    <div id="app"></div>
  </main>

  <!-- Toast container -->
  <div id="toastContainer" class="toast"></div>

  <!-- Templates -->
  <template id="homeTpl">
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
      <div>
        <h1 class="text-4xl lg:text-5xl font-extrabold text-gray-900">Timeline Pementasan <span class="gold">Oktoberâ€“November</span></h1>
        <p class="mt-4 text-gray-600 max-w-xl">Rancang jadwal pementasan, dokumentasikan proses kreatif, dan kolaborasikan semuanya dalam satu ruang. Edit dengan Markdown, ekspor ke PDF, Word, Excel, atau Kalender â€” langsung di browser.</p>
        <div class="mt-6 flex gap-3">
          <button id="ctaSeeTimeline" class="px-5 py-3 rounded-lg font-semibold" style="background:var(--purple-900); color:white">Lihat Timeline</button>
          <button id="ctaLogin" class="px-5 py-3 rounded-lg border border-gray-200">Login untuk Edit</button>
        </div>
        <div class="mt-6 text-sm text-gray-500">Prototype â€” data tersimpan di browser. Untuk produksi, integrasikan NextAuth + Supabase atau Firebase.</div>
      </div>
      <div class="card p-6">
        <h3 class="font-semibold">Agenda Terdekat</h3>
        <div id="upcomingList" class="mt-4 space-y-3"></div>
      </div>
    </section>
  </template>

  <template id="timelineTpl">
    <section>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold">Timeline</h2>
        <div class="flex items-center gap-3">
          <input id="searchInput" type="text" placeholder="Cari kegiatan..." class="px-3 py-2 border rounded-md" />
          <select id="filterCategory" class="px-3 py-2 border rounded-md">
            <option value="">Semua Kategori</option>
          </select>
          <select id="filterStatus" class="px-3 py-2 border rounded-md">
            <option value="">Semua Status</option>
            <option value="Mendatang">Mendatang</option>
            <option value="Selesai">Selesai</option>
          </select>
          <button id="btnAdd" class="px-3 py-2 rounded-md bg-white border">Tambah</button>
          <div class="relative">
            <button id="btnExport" class="px-3 py-2 rounded-md bg-white border">Ekspor</button>
            <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white border rounded-md p-2 shadow-lg">
              <button data-type="md" class="w-full text-left py-1 px-2 hover:bg-gray-100">Export .md</button>
              <button data-type="pdf" class="w-full text-left py-1 px-2 hover:bg-gray-100">Export .pdf</button>
              <button data-type="docx" class="w-full text-left py-1 px-2 hover:bg-gray-100">Export .docx</button>
              <button data-type="xlsx" class="w-full text-left py-1 px-2 hover:bg-gray-100">Export .xlsx</button>
              <button data-type="ics" class="w-full text-left py-1 px-2 hover:bg-gray-100">Export .ics</button>
            </div>
          </div>
          <div class="relative">
            <button id="btnImport" class="px-3 py-2 rounded-md bg-white border">Impor</button>
          </div>
        </div>
      </div>

      <div id="timelineList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>
  </template>

  <template id="adminTpl">
    <section>
      <h2 class="text-2xl font-semibold mb-4">Admin (Mock)</h2>
      <div class="card p-4">
        <h3 class="font-medium">Pengguna (mock)</h3>
        <div id="userList" class="mt-3"></div>
      </div>
    </section>
  </template>

  <!-- Modal Editor -->
  <div id="editorModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <div id="editorTitle" class="font-semibold">Edit item</div>
          <div class="text-xs text-gray-500">Edit konten dalam Markdown. Auto-save aktif.</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnHistory" class="px-3 py-2 text-sm border rounded-md">Riwayat</button>
          <button id="btnCloseEditor" class="px-3 py-2 text-sm border rounded-md">Tutup</button>
        </div>
      </div>
      <div class="flex-1 grid grid-cols-1 lg:grid-cols-2">
        <div class="p-4 border-r overflow-auto">
          <label class="text-xs text-gray-500">Tanggal / Periode</label>
          <input id="editorDate" class="mt-1 mb-3 px-3 py-2 border rounded-md w-full" />
          <label class="text-xs text-gray-500">Kategori</label>
          <input id="editorCategory" class="mt-1 mb-3 px-3 py-2 border rounded-md w-full" />
          <label class="text-xs text-gray-500">Status</label>
          <select id="editorStatus" class="mt-1 mb-3 px-3 py-2 border rounded-md w-full"><option>Mendatang</option><option>Selesai</option></select>
          <label class="text-xs text-gray-500">Konten (Markdown)</label>
          <textarea id="editorMarkdown" class="mt-1 w-full h-56 p-3 border rounded-md font-mono text-sm"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="btnSave" class="px-4 py-2 bg-gradient-to-r from-purple-700 to-purple-500 text-white rounded-md">Simpan</button>
            <button id="btnDelete" class="px-4 py-2 border rounded-md text-red-600">Hapus</button>
          </div>
        </div>
        <div class="p-4 overflow-auto">
          <div class="text-xs text-gray-500">Preview</div>
          <div id="editorPreview" class="mt-2 prose max-w-none"></div>
          <div id="historyPanel" class="mt-4 hidden">
            <h4 class="font-semibold">Riwayat Versi</h4>
            <div id="historyList" class="mt-2 space-y-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import input hidden -->
  <input id="fileInput" type="file" class="hidden" />

  <script>
  /*********************
   * App State & Utils *
   *********************/
  const STORAGE_KEY = 'timeline_pementasan_v1';
  const USER_KEY = 'timeline_user_v1';

  const seed = [
    { tanggal: '2025-10-20', kegiatan: 'Finalisasi naskah & Rilis proposal sponsor', kategori: 'Agenda Terdekat', status: 'Mendatang', content: 'Finalisasi naskah dan merilis proposal ke calon sponsor.' },
    { tanggal: '2025-10-24', kegiatan: 'Pengajuan kolaborasi MSK BATIK 1', kategori: 'Agenda Terdekat', status: 'Mendatang', content: 'Mengajukan proposal kerjasama dengan MSK BATIK 1.' },
    { periode: 'M1 Oktober', kegiatan: 'Penyusunan Kepanitian, Penokohan, Bedah Naskah', kategori: 'Persiapan', content: 'Menyusun kepanitiaan; mendiskusikan peran.' },
    { periode: 'M2 Oktober â€“ M3 November', kegiatan: 'Latihan', kategori: 'Latihan', content: 'Jadwal latihan intensif.' },
    { periode: 'M4 Oktober', kegiatan: 'Workshop', kategori: 'Workshop', content: 'Workshop teknis untuk panggung.' },
    { periode: 'M1 November', kegiatan: 'Perancangan Artistik', kategori: 'Persiapan', content: 'Desain artistik dan kostum.' },
    { periode: 'M4 November', kegiatan: 'Pementasan', kategori: 'Puncak Acara', content: 'Malam pementasan utama.' }
  ];

  function now(){return new Date().toISOString();}
  function toast(msg, t=3000){
    const c = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = 'card p-3 mb-2';
    el.innerText = msg;
    c.appendChild(el);
    setTimeout(()=>{el.remove()}, t);
  }

  function loadData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
      return JSON.parse(JSON.stringify(seed));
    }
    try{return JSON.parse(raw);}catch(e){localStorage.setItem(STORAGE_KEY, JSON.stringify(seed)); return seed;}
  }
  function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

  function loadUser(){
    try{ return JSON.parse(localStorage.getItem(USER_KEY)); }catch(e){return null}
  }
  function saveUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }

  let data = loadData();
  let currentUser = loadUser();

  /*********************
   * Routing & Render  *
   *********************/
  const app = document.getElementById('app');
  const templates = {
    home: document.getElementById('homeTpl').content,
    timeline: document.getElementById('timelineTpl').content,
    admin: document.getElementById('adminTpl').content
  };

  function render(){
    const hash = location.hash.replace('#','') || '/home';
    app.innerHTML = '';
    if(hash.startsWith('/timeline')) renderTimeline();
    else if(hash.startsWith('/admin')) renderAdmin();
    else renderHome();
    renderAuthArea();
  }

  // Header nav
  document.getElementById('btnHome').onclick = ()=>{location.hash='/home';}
  document.getElementById('btnTimeline').onclick = ()=>{location.hash='/timeline';}
  document.getElementById('btnAdmin').onclick = ()=>{location.hash='/admin';}

  window.addEventListener('hashchange', render);

  function renderHome(){
    app.appendChild(document.importNode(templates.home, true));
    document.getElementById('ctaSeeTimeline').onclick = ()=>{location.hash='/timeline';}
    document.getElementById('ctaLogin').onclick = ()=>{openLoginModal();}
    const upEl = document.getElementById('upcomingList');
    upEl.innerHTML = '';
    const upcoming = data.filter(d=>d.tanggal && new Date(d.tanggal) >= new Date()).slice(0,5);
    upcoming.forEach(it=>{
      const div = document.createElement('div');
      div.className='p-3 rounded-md flex items-start gap-3 border';
      div.innerHTML = `<div class="w-12 text-sm font-semibold gold">${it.tanggal}</div><div><div class="font-medium">${it.kegiatan}</div><div class="text-xs text-gray-500">${it.kategori}</div></div>`;
      upEl.appendChild(div);
    });
  }

  function renderTimeline(){
    app.appendChild(document.importNode(templates.timeline, true));
    populateFilters();
    const timelineList = document.getElementById('timelineList');
    timelineList.innerHTML = '';
    data.forEach((item, idx)=>{
      const card = document.createElement('div');
      card.className='card p-4';
      const when = item.tanggal || item.periode || '';
      card.innerHTML = `
        <div class="flex items-start justify-between">
          <div>
            <div class="text-xs text-gray-500">${when}</div>
            <div class="font-semibold mt-1">${item.kegiatan}</div>
            <div class="text-sm text-gray-500 mt-2">${item.kategori || ''}</div>
            <div class="text-xs mt-2 ${item.status==='Mendatang'?'gold':'text-green-600'}">${item.status||''}</div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <button data-idx="${idx}" class="btnEdit px-3 py-1 rounded-md border text-sm">Edit</button>
            <button data-idx="${idx}" class="btnExportItem px-3 py-1 rounded-md border text-sm">Export</button>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-700">${marked.parse(item.content||'')}</div>
      `;
      timelineList.appendChild(card);
    });

    // attach events
    document.querySelectorAll('.btnEdit').forEach(b=>b.onclick = e=>{ openEditor(parseInt(e.target.dataset.idx)); });
    document.querySelectorAll('.btnExportItem').forEach(b=>b.onclick = e=>{ exportSingle(parseInt(e.target.dataset.idx)); });

    // search/filter
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterCategory').addEventListener('change', applyFilters);
    document.getElementById('filterStatus').addEventListener('change', applyFilters);

    document.getElementById('btnAdd').onclick = ()=>{ addNewItem(); };

    // export menu
    const btnExport = document.getElementById('btnExport');
    const exportMenu = document.getElementById('exportMenu');
    btnExport.onclick = ()=>{ exportMenu.classList.toggle('hidden'); };
    exportMenu.querySelectorAll('button').forEach(b=>b.onclick = ()=>{ doExport(b.dataset.type); exportMenu.classList.add('hidden'); });

    document.getElementById('btnImport').onclick = ()=>{ document.getElementById('fileInput').click(); };
    document.getElementById('fileInput').onchange = handleFileImport;
  }

  function renderAdmin(){
    app.appendChild(document.importNode(templates.admin, true));
    const list = document.getElementById('userList');
    list.innerHTML = '';
    const u = loadUser();
    const el = document.createElement('div');
    el.className='p-3 border rounded-md';
    el.innerHTML = `<div class="font-medium">${u?u.email:'Belum ada user'}</div><div class="text-xs text-gray-500">Mock user data</div>`;
    list.appendChild(el);
  }

  function renderAuthArea(){
    const area = document.getElementById('authArea');
    area.innerHTML = '';
    if(currentUser){
      const wrap = document.createElement('div');
      wrap.className='flex items-center gap-3';
      const av = document.createElement('div'); av.className='w-9 h-9 rounded-full bg-gradient-to-br from-purple-700 to-purple-400 text-white flex items-center justify-center'; av.innerText = (currentUser.email||'U')[0].toUpperCase();
      const name = document.createElement('div'); name.className='text-sm'; name.innerText = currentUser.email;
      const btn = document.createElement('button'); btn.className='px-3 py-2 border rounded-md text-sm'; btn.innerText='Logout'; btn.onclick = ()=>{ logout(); };
      wrap.appendChild(av); wrap.appendChild(name); wrap.appendChild(btn);
      area.appendChild(wrap);
    } else {
      const btnLog = document.createElement('button'); btnLog.className='px-4 py-2 bg-white border rounded-md'; btnLog.innerText='Login'; btnLog.onclick = ()=> openLoginModal();
      area.appendChild(btnLog);
    }
  }

  /*********************
   * Editor Modal      *
   *********************/
  const editorModal = document.getElementById('editorModal');
  let editingIdx = null;
  let autoSaveTimer = null;

  function openEditor(idx){
    if(typeof idx === 'undefined' || idx === null) return;
    if(!currentUser){ alert('Silakan login dulu untuk mengedit.'); openLoginModal(); return; }
    editingIdx = idx;
    const it = data[idx];
    document.getElementById('editorTitle').innerText = it.kegiatan || 'Edit item';
    document.getElementById('editorDate').value = it.tanggal || it.periode || '';
    document.getElementById('editorCategory').value = it.kategori || '';
    document.getElementById('editorStatus').value = it.status || 'Mendatang';
    document.getElementById('editorMarkdown').value = it.content || '';
    document.getElementById('editorPreview').innerHTML = marked.parse(it.content || '');
    document.getElementById('historyList').innerHTML = '';
    // load versions if exist
    const versions = it._versions || [];
    versions.slice().reverse().forEach((v, i)=>{
      const but = document.createElement('div'); but.className='p-2 border rounded-md'; but.innerHTML = `<div class="text-xs text-gray-500">${v.time}</div><div class="font-medium">${v.summary||v.content.substring(0,60)}</div><div class="mt-2"><button class="restoreBtn px-2 py-1 border text-sm" data-vid="${versions.length-1-i}">Pulihkan</button></div>`;
      document.getElementById('historyList').appendChild(but);
    });
    document.getElementById('historyPanel').classList.toggle('hidden', versions.length===0);
    editorModal.classList.remove('hidden');
    gsap.fromTo(editorModal, {opacity:0}, {opacity:1, duration:0.3});

    // attach inputs
    document.getElementById('editorMarkdown').oninput = ()=>{ document.getElementById('editorPreview').innerHTML = marked.parse(document.getElementById('editorMarkdown').value); scheduleAutoSave(); };
    document.getElementById('btnCloseEditor').onclick = closeEditor;
    document.getElementById('btnSave').onclick = saveEditor;
    document.getElementById('btnDelete').onclick = ()=>{ if(confirm('Hapus item?')){ data.splice(editingIdx,1); saveData(data); toast('Item dihapus'); closeEditor(); render(); } };
    document.querySelectorAll('.restoreBtn').forEach(b=>b.onclick = e=>{ const vid = parseInt(e.target.dataset.vid); restoreVersion(vid); });
  }

  function closeEditor(){
    editorModal.classList.add('hidden');
    editingIdx = null;
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    render();
  }

  function scheduleAutoSave(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=>{ saveEditor(); }, 6000);
  }

  function saveEditor(){
    if(editingIdx===null) return;
    const it = data[editingIdx];
    // push version
    it._versions = it._versions || [];
    it._versions.push({time: now(), content: it.content||''});
    if(it._versions.length>5) it._versions.shift();
    // save new
    it.tanggal = document.getElementById('editorDate').value;
    it.periode = it.tanggal; // keep
    it.kategori = document.getElementById('editorCategory').value;
    it.status = document.getElementById('editorStatus').value;
    it.content = document.getElementById('editorMarkdown').value;
    it.kegiatan = it.kegiatan || it.content.split('\n')[0] || 'Untitled';
    saveData(data);
    toast('Tersimpan');
    render();
  }

  function restoreVersion(vid){
    const it = data[editingIdx];
    const v = it._versions[vid];
    if(!v) return; if(!confirm('Pulihkan versi ini?')) return;
    it._versions.push({time: now(), content: it.content||''});
    it.content = v.content;
    saveData(data); toast('Versi dipulihkan'); render(); closeEditor();
  }

  function addNewItem(){
    if(!currentUser){ alert('Silakan login dulu untuk menambah.'); openLoginModal(); return; }
    const newItem = {tanggal: new Date().toISOString().split('T')[0], kegiatan: 'Kegiatan baru', kategori:'Persiapan', status:'Mendatang', content:'Deskripsi kegiatan baru.'};
    data.unshift(newItem); saveData(data); render(); openEditor(0);
  }

  /*********************
   * Search & Filter    *
   *********************/
  function populateFilters(){
    const catSet = new Set(); data.forEach(d=>{ if(d.kategori) catSet.add(d.kategori); });
    const sel = document.getElementById('filterCategory'); sel.innerHTML = '<option value="">Semua Kategori</option>';
    catSet.forEach(c=>{ const o = document.createElement('option'); o.value=c; o.innerText=c; sel.appendChild(o); });
  }
  function applyFilters(){
    const q = document.getElementById('searchInput').value.toLowerCase();
    const cat = document.getElementById('filterCategory').value;
    const stat = document.getElementById('filterStatus').value;
    const cards = document.querySelectorAll('#timelineList > div');
    data.forEach((it, i)=>{
      const txt = (it.kegiatan + ' ' + (it.content||'') + ' ' + (it.kategori||'')).toLowerCase();
      let show = true;
      if(q && !txt.includes(q)) show=false;
      if(cat && it.kategori !== cat) show=false;
      if(stat && it.status !== stat) show=false;
      if(cards[i]) cards[i].style.display = show ? 'block' : 'none';
    });
  }

  /*********************
   * Export / Import    *
   *********************/
  function exportSingle(idx){
    const it = data[idx];
    const md = `# ${it.kegiatan}\n\n**Tanggal/Periode:** ${it.tanggal||it.periode||''}\n**Kategori:** ${it.kategori||''}\n**Status:** ${it.status||''}\n\n---\n\n${it.content||''}`;
    const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
    saveAs(blob, `${(it.kegiatan||'item').replace(/\s+/g,'_')}.md`);
    toast('Ekspor .md berhasil');
  }

  function doExport(type){
    if(type==='md'){
      const md = data.map(it=>`# ${it.kegiatan}\n\n**Tanggal/Periode:** ${it.tanggal||it.periode||''}\n**Kategori:** ${it.kategori||''}\n**Status:** ${it.status||''}\n\n${it.content||''}`).join('\n\n---\n\n');
      saveAs(new Blob([md],{type:'text/markdown;charset=utf-8'}), 'timeline.md');
      toast('Ekspor .md berhasil');
    } else if(type==='pdf'){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20; doc.setFontSize(16); doc.text('Timeline Pementasan', 14, y); y+=8; doc.setFontSize(10);
      data.forEach(it=>{
        doc.text(`- ${it.kegiatan} (${it.tanggal||it.periode||''})`, 14, y); y+=6; if(y>270){ doc.addPage(); y=20; }
      });
      doc.save('timeline.pdf'); toast('PDF diunduh');
    } else if(type==='xlsx'){
      const wsData = [['Tanggal/Periode','Kegiatan','Kategori','Status','Konten']];
      data.forEach(it=> wsData.push([it.tanggal||it.periode||'', it.kegiatan, it.kategori, it.status, it.content||'']));
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, 'Timeline');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([wbout],{type:'application/octet-stream'}), 'timeline.xlsx'); toast('Excel diunduh');
    } else if(type==='docx'){
      try{
        const docx = window.docx;
        const doc = new docx.Document();
        data.forEach(it=>{
          doc.addSection({children:[new docx.Paragraph({text: it.kegiatan, heading: docx.HeadingLevel.HEADING_2}), new docx.Paragraph({text: `${it.tanggal||it.periode||''} â€¢ ${it.kategori||''}`}), new docx.Paragraph({text: it.content||''})]});
        });
        docx.Packer.toBlob(doc).then(blob=>{ saveAs(blob, 'timeline.docx'); toast('Word diunduh'); });
      }catch(e){ toast('Ekspor .docx tidak tersedia di browser ini'); }
    } else if(type==='ics'){
      // simple ICS builder
      let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TimelinePrototype//EN\n';
      data.forEach((it,i)=>{
        if(!it.tanggal) return;
        const dt = it.tanggal.replace(/-/g,'') + 'T090000';
        ics += 'BEGIN:VEVENT\n';
        ics += `UID:timeline-${i}@local\n`;
        ics += `DTSTAMP:${dt}\n`;
        ics += `DTSTART:${dt}\n`;
        ics += `SUMMARY:${it.kegiatan}\n`;
        ics += `DESCRIPTION:${(it.content||'').replace(/\n/g,'\\n')}\n`;
        ics += 'END:VEVENT\n';
      });
      ics += 'END:VCALENDAR';
      saveAs(new Blob([ics],{type:'text/calendar'}), 'timeline.ics'); toast('Kalender (ICS) diunduh');
    }
  }

  async function handleFileImport(ev){
    const file = ev.target.files[0]; if(!file) return;
    const name = file.name.toLowerCase();
    if(name.endsWith('.md')){
      const txt = await file.text();
      // naive split by --- separator
      const parts = txt.split(/\n---\n/);
      parts.forEach(p=>{
        const lines = p.split('\n');
        const title = (lines[0]||'').replace(/^#\s*/,'').trim();
        const body = lines.slice(1).join('\n').trim();
        data.push({tanggal:'', kegiatan:title||'Imported', kategori:'Imported', status:'Mendatang', content:body});
      });
      saveData(data); toast('Markdown diimpor'); render();
    } else if(name.endsWith('.json')){
      const txt = await file.text(); try{ const j = JSON.parse(txt); if(Array.isArray(j)){ data = data.concat(j); saveData(data); toast('JSON diimpor'); render(); } }catch(e){ toast('JSON tidak valid'); }
    } else if(name.endsWith('.xlsx') || name.endsWith('.xls')){
      const arr = await file.arrayBuffer(); const wb = XLSX.read(arr); const ws = wb.Sheets[wb.SheetNames[0]]; const aoa = XLSX.utils.sheet_to_json(ws, {header:1});
      aoa.slice(1).forEach(row=>{
        const [tanggal, kegiatan, kategori, status, content] = row; data.push({tanggal: tanggal||'', kegiatan: kegiatan||'Imported', kategori: kategori||'Imported', status: status||'Mendatang', content: content||''});
      }); saveData(data); toast('Excel diimpor'); render();
    } else if(name.endsWith('.ics')){
      const txt = await file.text(); // naive parsing for DTSTART & SUMMARY
      const events = txt.split('BEGIN:VEVENT').slice(1);
      events.forEach(e=>{
        const dt = (e.match(/DTSTART:(.*?)\n/)||[])[1]; const sum = (e.match(/SUMMARY:(.*?)\n/)||[])[1];
        const date = dt ? dt.slice(0,8).replace(/(\d{4})(\d{2})(\d{2})/,'$1-$2-$3') : '';
        data.push({tanggal: date, kegiatan: sum||'Imported', kategori:'Imported', status:'Mendatang', content:''});
      }); saveData(data); toast('ICS diimpor'); render();
    } else { toast('Format tidak dikenali'); }
    ev.target.value = '';
  }

  /*********************
   * Login Mock        *
   *********************/
  function openLoginModal(){
    const email = prompt('Masukkan email (mock login)');
    if(!email) return; const user = {email: email, time: now()}; currentUser = user; saveUser(user); render(); toast('Login sukses (mock)');
  }
  function logout(){ currentUser=null; localStorage.removeItem(USER_KEY); render(); toast('Logout'); }

  /*********************
   * Init              *
   *********************/
  render();

  // small helpers
  function exportAllAsJSON(){ saveAs(new Blob([JSON.stringify(data, null,2)],{type:'application/json'}),'timeline.json'); }

  // quick keyboard: press n to add if logged
  window.addEventListener('keydown', (e)=>{ if(e.key==='n'){ addNewItem(); } });
  </script>
</body>
</html>
